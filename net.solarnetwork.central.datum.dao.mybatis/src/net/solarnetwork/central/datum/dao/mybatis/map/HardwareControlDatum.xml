<?xml version="1.0" encoding="UTF-8"?><!--Converted at: Thu Nov 13 07:30:22 NZDT 2014-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.solarnetwork.central.datum.dao.mybatis.HardwareControlDatum">

	<insert id="insert-HardwareControlDatum" parameterType="HardwareControlDatum">
		<selectKey keyProperty="id" resultType="long" order="BEFORE"> 
              SELECT nextval('solarnet.hardware_control_seq') AS id 
		</selectKey>
		INSERT INTO solarnet.sn_hardware_control_datum 
			(id
			<if test="created != null">,created</if>
			, node_id, source_id, int_val, float_val)
		VALUES
			(#{id}
			<if test="created != null">,#{created}</if>
			, #{nodeId}, #{sourceId}, #{integerValue}, #{floatValue})
	</insert>

	<update id="update-HardwareControlDatum" parameterType="HardwareControlDatum">
		UPDATE 
			solarnet.sn_hardware_control_datum
		SET
			source_id = #{sourceId},
			int_val = #{integerValue}
			float_val = #{floatValue}
		WHERE
			id = #{id}
	</update>

	<sql id="fragment-HardwareControlDatum-full-result">
		hcdatum.id AS sn_hardware_control_datum_id,
		hcdatum.created AS sn_hardware_control_datum_created,
		hcdatum.node_id AS sn_hardware_control_datum_node_id,
		hcdatum.source_id AS sn_hardware_control_datum_source_id,
		hcdatum.int_val AS sn_hardware_control_datum_int_val,
		hcdatum.float_val AS sn_hardware_control_datum_float_val
	</sql>
	
	<resultMap id="HardwareControlDatumFullResult" type="HardwareControlDatum">
		<id property="id" column="sn_hardware_control_datum_id"/>
		<result property="created" column="sn_hardware_control_datum_created"/>
		<result property="nodeId" column="sn_hardware_control_datum_node_id"/>
		<result property="sourceId" column="sn_hardware_control_datum_source_id"/>
		<result property="integerValue" column="sn_hardware_control_datum_int_val"/>
		<result property="floatValue" column="sn_hardware_control_datum_float_val"/>
	</resultMap>
	
	<select id="get-HardwareControlDatum-for-id" resultMap="HardwareControlDatumFullResult">
		SELECT
			<include refid="fragment-HardwareControlDatum-full-result"/>
		FROM
			solarnet.sn_hardware_control_datum hcdatum
		WHERE
			hcdatum.id = #{id}
	</select>
	
	<select id="find-HardwareControlDatum-for-date" resultMap="HardwareControlDatumFullResult">
		SELECT
			<include refid="fragment-HardwareControlDatum-full-result"/>
		FROM
			solarnet.sn_hardware_control_datum hcdatum
		WHERE
			hcdatum.node_id = #{id}
			AND hcdatum.created = #{date,jdbcType=TIMESTAMP}
	</select>
	
	<select id="find-HardwareControlDatum-most-recent" resultMap="HardwareControlDatumFullResult">
		SELECT
			<include refid="fragment-HardwareControlDatum-full-result"/>
		FROM
			solarnet.sn_hardware_control_datum_most_recent recent
		INNER JOIN
			solarnet.sn_hardware_control_datum hcdatum ON hcdatum.id = recent.datum_id
		WHERE
			recent.node_id = #{node}
			<if test="source != null">
				AND recent.source_id = #{source}
			</if>
		ORDER BY
			hcdatum.source_id
	</select>
	
	<!-- HardwareControlDatumMatch support -->
	
	<resultMap id="HardwareControlDatumMatchResult" type="HardwareControlDatumMatch" extends="net.solarnetwork.central.datum.dao.mybatis.HardwareControlDatum.HardwareControlDatumFullResult"/>
	
	<sql id="fragment-findall-HardwareControlDatum-HardwareControlDatumMatch">
		FROM
			solarnet.sn_hardware_control_datum hcdatum
		<if test="filter != null">
			<where>
				<if test="filter.sourceIds != null and filter.sourceIds.length > 0">
					AND hcdatum.source_id IN
					<foreach collection="filter.sourceIds" open="(" close=")" separator="," item="source">
						#{source,javaType=string,jdbcType=VARCHAR}
					</foreach>
				</if>
				<if test="filter.nodeIds != null and filter.nodeIds.length > 0">
					AND hcdatum.node_id IN
					<foreach collection="filter.nodeIds" open="(" close=")" separator="," item="node">
						#{node,javaType=long,jdbcType=BIGINT}
					</foreach>
				</if>
				<if test="filter.startDate != null">
					AND hcdatum.created &gt;= #{filter.startDate,javaType=org.joda.time.DateTime,jdbcType=TIMESTAMP}
				</if>
				<if test="filter.endDate != null">
					AND hcdatum.created &lt; #{filter.endDate,javaType=org.joda.time.DateTime,jdbcType=TIMESTAMP}
				</if>
			</where>
		</if>
	</sql>

	<select id="findall-HardwareControlDatum-HardwareControlDatumMatch" resultMap="HardwareControlDatumMatchResult" fetchSize="250" resultSetType="FORWARD_ONLY">
		SELECT
			<include refid="fragment-HardwareControlDatum-full-result"/>
		<include refid="fragment-findall-HardwareControlDatum-HardwareControlDatumMatch"/>
		ORDER BY
		<choose>
			<when test="SortDescriptors != null and SortDescriptors.size &gt; 0">
				 <foreach collection="SortDescriptors" item="item" separator=",">
					<if test="item.sortKey == &quot;created&quot;">hcdatum.created</if>
					<if test="item.sortKey == &quot;node&quot;">hcdatum.node_id</if>
					<if test="item.sortKey == &quot;source&quot;">hcdatum.source_id</if>
					<if test="item.descending">DESC</if>
				</foreach>
			</when>
			<otherwise>
				hcdatum.id
			</otherwise>
		</choose>
	</select>

	<select id="findall-HardwareControlDatum-HardwareControlDatumMatch-count" resultType="long">
		SELECT count(hcdatum.id)
		<include refid="fragment-findall-HardwareControlDatum-HardwareControlDatumMatch"/>
	</select>
	
</mapper>